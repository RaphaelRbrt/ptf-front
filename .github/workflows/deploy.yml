name: Deploy CVB Admin

on:
  push:
    branches:
      - main
      - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: raphaelrbrt/ptf-front

jobs:
  build-and-push:
    if: ${{ !contains(github.event.head_commit.message, 'Deploy') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-k8s-manifests:
    needs: build-and-push
    if: ${{ !contains(github.event.head_commit.message, 'Deploy') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
            echo "path=k8s/production" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> "$GITHUB_OUTPUT"
            echo "path=k8s/staging" >> "$GITHUB_OUTPUT"
          fi

      - name: Update deployment manifest
        run: |
          mkdir -p ${{ steps.env.outputs.path }}
          cat > ${{ steps.env.outputs.path }}/deployment.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ptf-front
            template:
              metadata:
                labels:
                  app: ptf-front
              spec:
                serviceAccountName: ptf-front
                imagePullSecrets:
                  - name: ghcr-secret 
                containers:
                - name: admin
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
                  ports:
                  - containerPort: 3000
                  env:
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: cvb-secrets
                        key: database-url
                  - name: REDIS_URL
                    valueFrom:
                      secretKeyRef:
                        name: cvb-secrets
                        key: redis-url
                  - name: SECRET_KEY
                    valueFrom:
                      secretKeyRef:
                        name: cvb-secrets
                        key: ptf-front-secret-key
                  - name: KUBERNETES_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "50m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          EOF

      - name: Create Service manifest
        run: |
          cat > ${{ steps.env.outputs.path }}/service.yaml <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          spec:
            selector:
              app: ptf-front
            ports:
            - port: 3000
              targetPort: 3000
          EOF

      - name: Create ServiceAccount and RBAC
        run: |
          cat > ${{ steps.env.outputs.path }}/rbac.yaml <<EOF
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          rules:
          - apiGroups: [""]
            resources: ["pods", "services"]
            verbs: ["get", "list", "watch", "delete"]
          - apiGroups: ["apps"]
            resources: ["deployments", "statefulsets"]
            verbs: ["get", "list", "watch", "patch"]
          - apiGroups: [""]
            resources: ["pods/log"]
            verbs: ["get", "list"]
          - apiGroups: ["batch"]
            resources: ["jobs"]
            verbs: ["get", "list", "watch", "create", "delete"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          subjects:
          - kind: ServiceAccount
            name: ptf-front
            namespace: cvb-${{ steps.env.outputs.environment }}
          roleRef:
            kind: Role
            name: ptf-front
            apiGroup: rbac.authorization.k8s.io
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Deploy (${{ steps.env.outputs.environment }}): Update image to sha-${{ github.sha }}"

      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          branch: ${{ github.ref_name }}
