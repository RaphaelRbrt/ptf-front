name: Deploy PTF Front

on:
  push:
    branches:
      - main
      - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: raphaelrbrt/ptf-front

jobs:
  build-and-push:
    if: ${{ !contains(github.event.head_commit.message, 'Deploy') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,format=long

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-k8s-manifests:
    needs: build-and-push
    if: ${{ !contains(github.event.head_commit.message, 'Deploy') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
            echo "path=k8s/production" >> "$GITHUB_OUTPUT"
            echo "host=raphaelrbr.com" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> "$GITHUB_OUTPUT"
            echo "path=k8s/staging" >> "$GITHUB_OUTPUT"
            echo "host=staging.raphaelrbr.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Update deployment manifest
        run: |
          mkdir -p ${{ steps.env.outputs.path }}
          cat > ${{ steps.env.outputs.path }}/deployment.yaml <<'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ptf-front
            template:
              metadata:
                labels:
                  app: ptf-front
              spec:
                serviceAccountName: ptf-front
                imagePullSecrets:
                  - name: ghcr-secret
                securityContext:
                  runAsNonRoot: true
                  seccompProfile:
                    type: RuntimeDefault
                containers:
                - name: frontend
                  image: ghcr.io/raphaelrbrt/ptf-front:sha-${{ github.sha }}
                  securityContext:
                    allowPrivilegeEscalation: false
                    capabilities:
                      drop:
                        - ALL
                  ports:
                  - containerPort: 3000
                  env:
                  - name: NODE_ENV
                    value: "production"
                  - name: KUBERNETES_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "50m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          EOF

      - name: Create Service manifest
        run: |
          cat > ${{ steps.env.outputs.path }}/service.yaml <<'EOF'
          apiVersion: v1
          kind: Service
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          spec:
            selector:
              app: ptf-front
            ports:
            - port: 3000
              targetPort: 3000
          EOF

      - name: Create ServiceAccount and RBAC
        run: |
          cat > ${{ steps.env.outputs.path }}/rbac.yaml <<'EOF'
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          rules:
          - apiGroups: [""]
            resources: ["pods", "services"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["apps"]
            resources: ["deployments"]
            verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          subjects:
          - kind: ServiceAccount
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          roleRef:
            kind: Role
            name: ptf-front
            apiGroup: rbac.authorization.k8s.io
          EOF

      - name: Write ingress.yaml
        run: |
          cat > ${{ steps.env.outputs.path }}/ingress.yaml <<'EOF'
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: ptf-front
            namespace: ptf-${{ steps.env.outputs.environment }}
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`${{ steps.env.outputs.host }}`)
                kind: Rule
                services:
                  - name: ptf-front
                    port: 3000
                middlewares:
                  - name: compress
                  - name: security-headers
            tls:
              secretName: ptf-${{ steps.env.outputs.environment }}-tls
          ---
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: compress
            namespace: ptf-${{ steps.env.outputs.environment }}
          spec:
            compress: {}
          ---
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: security-headers
            namespace: ptf-${{ steps.env.outputs.environment }}
          spec:
            headers:
              frameDeny: true
              browserXssFilter: true
              contentTypeNosniff: true
              forceSTSHeader: true
              stsIncludeSubdomains: true
              stsPreload: true
              stsSeconds: 31536000
          EOF

      - name: Write kustomization.yaml
        run: |
          cat > ${{ steps.env.outputs.path }}/kustomization.yaml <<'EOF'
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          namespace: ptf-${{ steps.env.outputs.environment }}

          resources:
            - deployment.yaml
            - service.yaml
            - rbac.yaml
            - ingress.yaml

          commonLabels:
            app: ptf-front
            environment: ${{ steps.env.outputs.environment }}
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --rebase origin ${{ github.ref_name }} || true
          git add .
          git commit -m "Deploy (${{ steps.env.outputs.environment }}): Update image to sha-${{ github.sha }}" || true

      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          branch: ${{ github.ref_name }}
          force: true
